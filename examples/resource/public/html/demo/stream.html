<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能对话助手</title>
    <!-- 移除了Font Awesome CDN引用，将使用内联SVG图标替代 -->

    <!-- 自定义工具类 -->
    <!-- 内联基础样式，确保在外部资源加载失败时页面也能正常显示 -->
    <style>
        /* 基础重置和全局样式 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #F7F7F8;
            color: #1F2937;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* 布局样式 */
        header {
            border-bottom: 1px solid #E4E4E7;
            background-color: white;
            backdrop-filter: blur(8px);
            position: sticky;
            top: 0;
            z-index: 30;
            padding: 1rem;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .flex-1 {
            flex: 1;
        }

        main {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        /* 聊天区域样式 */
        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 2rem;
        }

        #chat-messages::-webkit-scrollbar {
            display: none;
        }

        #chat-messages {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 消息气泡样式 */
        .message-appear {
            animation: messageAppear 0.3s ease-out forwards;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .max-w-3xl {
            max-width: 48rem;
        }

        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }

        .mb-8 {
            margin-bottom: 2rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .justify-end {
            justify-content: flex-end;
        }

        .bg-primary {
            background-color: #10A37F;
        }

        .bg-neutral-light {
            background-color: #E4E4E7;
        }

        .rounded-lg {
            border-radius: 0.5rem;
        }

        .rounded-tr-none {
            border-top-right-radius: 0;
        }

        .rounded-tl-none {
            border-top-left-radius: 0;
        }

        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .py-3 {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }

        .text-white {
            color: white;
        }

        .text-text-primary {
            color: #1F2937;
        }

        .text-text-secondary {
            color: #6B7280;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .w-8,
        .h-8 {
            width: 2rem;
            height: 2rem;
        }

        .rounded-md {
            border-radius: 0.375rem;
        }

        .rounded-full {
            border-radius: 9999px;
        }

        .flex-shrink-0 {
            flex-shrink: 0;
        }

        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 输入区域样式 */
        .border-t {
            border-top: 1px solid #E4E4E7;
        }

        .p-4 {
            padding: 1rem;
        }

        .bg-white {
            background-color: white;
        }

        .relative {
            position: relative;
        }

        #message-input {
            width: 100%;
            background-color: white;
            border: 1px solid #E4E4E7;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            padding-right: 3rem;
            outline: none;
            resize: none;
            height: 4rem;
            color: #1F2937;
            transition: border-color 0.2s;
        }

        #message-input:focus {
            border-color: #10A37F;
        }

        button {
            position: absolute;
            right: 0.75rem;
            bottom: 0.75rem;
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            background-color: #10A37F;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: rgba(16, 163, 127, 0.9);
        }

        /* 打字指示器样式 */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background-color: #6B7280;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {
            0% {
                transform: translateY(0px);
            }

            28% {
                transform: translateY(-5px);
            }

            44% {
                transform: translateY(0px);
            }
        }

        /* 列表样式 */
        ul {
            list-style-type: disc;
            padding-left: 1.25rem;
            margin-bottom: 0.75rem;
        }

        li {
            margin-bottom: 0.25rem;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-3 {
            margin-bottom: 0.75rem;
        }

        /* SVG图标样式 */
        .icon {
            width: 16px;
            height: 16px;
            display: block;
        }

        .icon-user,
        .icon-comments,
        .icon-send {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }
    </style>

    <!-- 完全使用内联CSS，不依赖任何外部样式库 -->
</head>

<body class="bg-neutral font-inter text-text-primary min-h-screen flex flex-col overflow-hidden">

    <div class="flex flex-1 overflow-hidden">
        <!-- 侧边栏 -->

        <!-- 主聊天区域 -->
        <main class="flex-1 flex flex-col">
            <!-- 聊天消息区域 -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 md:p-8 scrollbar-hide">
                <!-- 欢迎消息 -->
                <div class="max-w-3xl mx-auto mb-8 message-appear">
                    <div class="flex gap-4">
                        <div class="w-8 h-8 rounded-md bg-primary flex-shrink-0 flex-center">
                            <svg class="icon-comments" viewBox="0 0 16 16">
                                <path
                                    d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z" />
                            </svg>
                        </div>
                        <div class="bg-neutral-light rounded-lg px-4 py-3 text-text-primary">
                            <p class="mb-2">你好！我是智能对话助手，有什么我可以帮助你的吗？</p>
                            <p class="text-text-secondary text-sm">你可以问我任何问题，我会尽力为你解答。</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- 输入区域 -->
            <div class="border-t border-neutral-light p-4 bg-white backdrop-blur-sm">
                <div class="max-w-3xl mx-auto">
                    <form id="chat-form" class="relative">
                        <textarea id="message-input" placeholder="请输入......"
                            class="w-full bg-white border border-neutral-light rounded-lg px-4 py-3 pr-12 focus:outline-none focus:border-primary transition-colors resize-none h-16 text-text-primary overflow-hidden">北京有哪些名胜古迹呢</textarea>
                        <button type="submit"
                            class="absolute right-3 bottom-3 w-8 h-8 rounded-full bg-primary flex items-center justify-center hover:bg-primary/90 transition-colors">
                            <svg class="icon-send" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="#000000" stroke-linecap="round" stroke-linejoin="round"
                                id="Send--Streamline-Tabler" height="24" width="24">
                                <path d="M10 14 21 3" stroke-width="2"></path>
                                <path d="m21 3 -6.5 18a0.55 0.55 0 0 1 -1 0L10 14l-7 -3.5a0.55 0.55 0 0 1 0 -1L21 3"
                                    stroke-width="2"></path>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 侧边栏切换 - 添加安全检查
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');

        if (sidebarToggle && sidebar) {
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('hidden');
                sidebar.classList.toggle('absolute');
                sidebar.classList.toggle('h-full');
            });

            // 点击外部关闭侧边栏（移动设备）
            document.addEventListener('click', (e) => {
                if (window.innerWidth < 1024 &&
                    !sidebar.classList.contains('hidden') &&
                    !sidebar.contains(e.target) &&
                    e.target !== sidebarToggle) {
                    sidebar.classList.add('hidden');
                }
            });
        }

        // 聊天表单提交
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');

        // 添加调试日志，确认元素是否正确获取
        console.log('chatForm:', chatForm);
        console.log('messageInput:', messageInput);
        console.log('chatMessages:', chatMessages);

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();

            // 确保正确获取消息输入框的值
            const currentInput = document.getElementById('message-input');
            const message = currentInput ? currentInput.value.trim() : '';
            if (!message) {
                return;
            }

            // 添加用户消息
            addUserMessage(message);

            // 清空输入框
            if (currentInput) {
                currentInput.value = '';
                adjustTextareaHeight();
            }

            // 显示正在输入状态
            showTypingIndicator();

            // 立即发送stream请求
            removeTypingIndicator();

            // 添加AI回复（发送stream请求）
            addAiResponse(message);
        });

        // 页面加载后2秒自动触发表单提交
        setTimeout(() => {
            const autoSubmitForm = document.getElementById('chat-form');
            const autoInput = document.getElementById('message-input');
            // 只有当表单存在且输入框有内容时才自动提交
            if (autoSubmitForm && autoInput && autoInput.value.trim()) {
                console.log('页面加载2秒后自动触发表单提交');
                autoSubmitForm.dispatchEvent(new Event('submit', { cancelable: true }));
            }
        }, 2000);

        // 也为按钮添加点击事件监听器作为备选
        const submitButton = chatForm.querySelector('button[type="submit"]');
        console.log('submitButton:', submitButton);
        if (submitButton) {
            submitButton.addEventListener('click', function (e) {
                console.log('按钮点击事件被触发!');
                // 触发表单提交
                chatForm.dispatchEvent(new Event('submit'));
            });
        }

        // 调整文本框高度
        messageInput.addEventListener('input', adjustTextareaHeight);

        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            const scrollHeight = messageInput.scrollHeight;
            // 限制最大高度
            messageInput.style.height = Math.min(scrollHeight, 120) + 'px';
        }

        // 添加用户消息
        function addUserMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'max-w-3xl mx-auto mb-8 opacity-0';
            messageDiv.innerHTML = `
        <div class="flex gap-4 justify-end">
          <div class="bg-primary rounded-lg rounded-tr-none px-4 py-3 text-white">
            <p>${escapeHtml(message)}</p>
          </div>
          <div class="w-8 h-8 rounded-full bg-primary flex-shrink-0 flex-center text-white">
              <svg class="icon-user" viewBox="0 0 16 16">
                <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
              </svg>
            </div>
        </div>
      `;

            chatMessages.appendChild(messageDiv);
            // 触发动画
            setTimeout(() => {
                messageDiv.classList.add('message-appear');
            }, 10);

            // 滚动到底部
            scrollToBottom();
        }

        // 显示正在输入状态
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'max-w-3xl mx-auto mb-8 opacity-0';
            typingDiv.innerHTML = `
        <div class="flex gap-4">
          <div class="w-8 h-8 rounded-md bg-primary flex-shrink-0 flex-center">
              <svg class="icon-comments" viewBox="0 0 16 16">
                <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
              </svg>
            </div>
          <div class="bg-neutral-light rounded-lg rounded-tl-none px-4 py-3 text-text-primary">
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
      `;

            chatMessages.appendChild(typingDiv);
            // 触发动画
            setTimeout(() => {
                typingDiv.classList.add('message-appear');
            }, 10);

            // 滚动到底部
            scrollToBottom();
        }

        // 移除正在输入状态
        function removeTypingIndicator() {
            const typingDiv = document.getElementById('typing-indicator');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        // 添加AI回复 - 支持流式响应
        function addAiResponse(prompt) {
            // 创建回复容器
            const responseDiv = document.createElement('div');
            responseDiv.className = 'max-w-3xl mx-auto mb-8 opacity-0';
            responseDiv.innerHTML = `
        <div class="flex gap-4">
          <div class="w-8 h-8 rounded-md bg-primary flex-shrink-0 flex-center">
              <svg class="icon-comments" viewBox="0 0 16 16">
                <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
              </svg>
            </div>
          <div class="bg-neutral-light rounded-lg rounded-tl-none px-4 py-3 text-text-primary">
            <p class="response-text"></p>
          </div>
        </div>
      `;

            chatMessages.appendChild(responseDiv);
            // 触发动画
            setTimeout(() => {
                responseDiv.classList.add('message-appear');
            }, 10);

            // 获取响应文本元素
            const responseTextElement = responseDiv.querySelector('.response-text');

            // 发送流式请求到 /api/demo/v1/stream 接口
            fetch('/api/demo/v1/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ prompt: prompt })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    // 获取响应流的 reader
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let accumulatedResponse = '';

                    // 读取流数据的函数
                    function readStream() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                console.log('Stream complete');
                                // 最后一次完整解析，确保所有内容都被正确渲染
                                const finalHtml = parseMarkdown(accumulatedResponse);
                                responseTextElement.innerHTML = finalHtml;
                                return;
                            }

                            // 解码新的流数据块
                            const chunk = decoder.decode(value, { stream: true });

                            // 解析JSON格式的响应 - 优化处理data:前缀格式
                            try {
                                // 处理可能的不完整JSON或多个JSON对象
                                const cleanChunk = chunk.trim();

                                // 处理可能包含多个data:块的情况
                                const dataBlocks = cleanChunk.split('data:');

                                for (let block of dataBlocks) {
                                    block = block.trim();
                                    if (block) { // 跳过空块
                                        try {
                                            // 尝试解析每个data块中的JSON
                                            const parsedData = JSON.parse(block);

                                            // 验证数据格式并提取text字段
                                            if (parsedData.type === 'text' && parsedData.text !== undefined) {
                                                accumulatedResponse += parsedData.text;

                                                // 使用Markdown解析函数处理响应内容
                                                const htmlContent = parseMarkdown(accumulatedResponse);
                                                responseTextElement.innerHTML = htmlContent;
                                            }
                                        } catch (jsonError) {
                                            // 单个块解析失败，尝试提取可能的JSON对象
                                            try {
                                                const jsonObjects = extractJsonObjects(block);

                                                if (jsonObjects.length > 0) {
                                                    // 处理找到的每个JSON对象
                                                    for (const jsonStr of jsonObjects) {
                                                        try {
                                                            const parsedObj = JSON.parse(jsonStr);
                                                            if (parsedObj.type === 'text' && parsedObj.text !== undefined) {
                                                                accumulatedResponse += parsedObj.text;
                                                            }
                                                        } catch (objError) {
                                                            // 忽略单个对象解析错误
                                                        }
                                                    }

                                                    // 如果有有效的内容被添加，更新UI
                                                    if (jsonObjects.length > 0) {
                                                        const htmlContent = parseMarkdown(accumulatedResponse);
                                                        responseTextElement.innerHTML = htmlContent;
                                                    }
                                                }
                                            } catch (extractError) {
                                                // 忽略提取错误，继续处理下一个块
                                            }
                                        }
                                    }
                                }
                            } catch (e) {
                                // 静默失败，确保流式传输不中断
                                console.warn('Error processing stream chunk:', e);
                            }

                            // 自动滚动到底部
                            responseTextElement.scrollIntoView({ behavior: 'smooth', block: 'end' });

                            // 继续读取流
                            readStream();
                        }).catch(error => {
                            console.error('Error reading stream:', error);
                            responseTextElement.textContent = 'Sorry, there was an error processing your request.';
                        });
                    }

                    // 开始读取流
                    readStream();
                })
                .catch(error => {
                    console.error('Error fetching stream:', error);
                    responseTextElement.textContent = 'Sorry, there was an error connecting to the server.';
                });

            // 滚动到底部
            setTimeout(() => {
                scrollToBottom();
            }, 10);
        }

        // 滚动到底部
        function scrollToBottom() {
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // 从字符串中提取有效的JSON对象
        function extractJsonObjects(text) {
            const result = [];
            let braceCount = 0;
            let startIndex = -1;
            let inString = false;
            let escapeNext = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];

                // 处理字符串内的情况
                if (char === '"' && !escapeNext) {
                    inString = !inString;
                }

                // 处理转义字符
                if (char === '\\') {
                    escapeNext = !escapeNext;
                } else {
                    escapeNext = false;
                }

                // 不在字符串内时处理括号
                if (!inString) {
                    if (char === '{') {
                        braceCount++;
                        if (braceCount === 1) {
                            startIndex = i;
                        }
                    } else if (char === '}') {
                        braceCount--;
                        if (braceCount === 0 && startIndex !== -1) {
                            // 找到一个完整的JSON对象
                            const jsonStr = text.substring(startIndex, i + 1);
                            result.push(jsonStr);
                            startIndex = -1;
                        } else if (braceCount < 0) {
                            // 括号不匹配，重置
                            braceCount = 0;
                            startIndex = -1;
                        }
                    }
                }
            }

            return result;
        }

        // 增强的Markdown解析函数
        function parseMarkdown(text) {
            // 预处理：处理文本中可能存在的特殊格式问题
            let processedText = text;

            // 预处理1: 在---、***、___等分割线前添加换行符，确保它们能被正确识别
            processedText = processedText.replace(/([^\n])---([^\n])/g, '$1\n---\n$2');
            processedText = processedText.replace(/([^\n])\*\*\*([^\n])/g, '$1\n***\n$2');
            processedText = processedText.replace(/([^\n])___([^\n])/g, '$1\n___\n$2');

            // 预处理2: 在标题标记前添加换行符，确保标题能被正确识别
            processedText = processedText.replace(/([^\n#])\s*(#{1,6})\s+/g, '$1\n$2 ');

            // 预处理3: 在列表项前添加换行符
            processedText = processedText.replace(/([^\n-])\s*-\s+/g, '$1\n- ');
            // 预处理4: 在数字列表项前添加换行符
            processedText = processedText.replace(/([^\n\d])\s*(\d+)\.\s+/g, '$1\n$2. ');

            // 转义HTML特殊字符
            let html = processedText
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');

            // 解析Markdown语法 - 按照优先级顺序处理
            // 1. 代码块（最高优先级）
            html = html.replace(/```([\s\S]*?)```/g, function (match, code) {
                return `<pre><code>${code}</code></pre>`;
            });

            // 2. 行内代码
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // 3. 标题 - 更宽松的匹配，允许不在行首的标题
            html = html.replace(/(^|\n)(#{1,6})\s+([^\n]+)/g, function (match, newline, hashes, content) {
                const level = hashes.length;
                return `${newline}<h${level}>${content}</h${level}>`;
            });

            // 4. 链接
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

            // 5. 粗体和斜体组合 (先处理粗体)
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');

            // 6. 斜体
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            html = html.replace(/_([^_]+)_/g, '<em>$1</em>');

            // 7. 列表项处理
            // 先将连续的无序列表项分组
            const unorderedListGroups = [];
            let currentUnorderedList = [];
            // 将连续的有序列表项分组
            const orderedListGroups = [];
            let currentOrderedList = [];
            
            const lines = html.split('\n');

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                // 处理无序列表项
                if (line.startsWith('- ')) {
                    // 如果当前正在处理有序列表，先保存
                    if (currentOrderedList.length > 0) {
                        orderedListGroups.push(currentOrderedList);
                        currentOrderedList = [];
                    }
                    currentUnorderedList.push(line);
                } 
                // 处理有序列表项（数字. 格式）
                else if (line.match(/^\d+\.\s/)) {
                    // 如果当前正在处理无序列表，先保存
                    if (currentUnorderedList.length > 0) {
                        unorderedListGroups.push(currentUnorderedList);
                        currentUnorderedList = [];
                    }
                    currentOrderedList.push(line);
                } 
                else {
                    // 保存当前列表
                    if (currentUnorderedList.length > 0) {
                        unorderedListGroups.push(currentUnorderedList);
                        currentUnorderedList = [];
                    }
                    if (currentOrderedList.length > 0) {
                        orderedListGroups.push(currentOrderedList);
                        currentOrderedList = [];
                    }
                }
            }
            
            // 保存剩余的列表
            if (currentUnorderedList.length > 0) {
                unorderedListGroups.push(currentUnorderedList);
            }
            if (currentOrderedList.length > 0) {
                orderedListGroups.push(currentOrderedList);
            }

            // 替换无序列表项
            for (const group of unorderedListGroups) {
                const listHtml = group.map(item => `<li>${item.substring(2)}</li>`).join('');
                const groupText = group.join('\n');
                html = html.replace(groupText, `<ul>${listHtml}</ul>`);
            }
            
            // 替换有序列表项
            for (const group of orderedListGroups) {
                // 提取数字后的内容，去掉数字和点
                const listHtml = group.map(item => {
                    const content = item.replace(/^\d+\.\s+/, '');
                    return `<li>${content}</li>`;
                }).join('');
                const groupText = group.join('\n');
                html = html.replace(groupText, `<ol>${listHtml}</ol>`);
            }

            // 8. 处理水平分割线 - 更宽松的匹配，不仅限于行首
            html = html.replace(/(^|\n)\s*[-*_]{3,}\s*(\n|$)/g, '$1<hr>$2');

            // 9. 段落处理 - 避免在已有的HTML标签内创建段落
            // 先分割文本为段落，再为每段添加p标签
            const paragraphs = html.split('\n\n');
            const formattedParagraphs = paragraphs.map(paragraph => {
                // 如果段落已经以HTML标签开始，不添加p标签
                if (paragraph.trim().match(/^\s*<[a-z]/i)) {
                    return paragraph;
                }
                return `<p>${paragraph}</p>`;
            });
            html = formattedParagraphs.join('');

            // 10. 保留换行符，但避免过多的br标签
            html = html.replace(/\n/g, '<br>');

            return html;
        }

        // HTML转义，防止XSS
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // 初始调整文本框高度
        adjustTextareaHeight();

        // 初始滚动到底部
        scrollToBottom();

        // 2秒后自动发送消息
        setTimeout(() => {
            const message = messageInput.value.trim();
            if (message) {
                // 模拟点击发送按钮
                const sendButton = chatForm.querySelector('button[type="submit"]');
                if (sendButton) {
                    sendButton.click();
                }
            }
        }, 2000);
    </script>
</body>

</html>